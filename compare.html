<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparar Productos - FutureLabs</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/header-improved.css">
    <link rel="stylesheet" href="css/footer-improved.css">
    <link rel="stylesheet" href="css/forms-improved.css">
    <link rel="stylesheet" href="css/modals-improved.css">
    <link rel="stylesheet" href="css/pages-common.css">
    <link rel="stylesheet" href="css/informational-pages-improved.css">
    <!-- Estilos inline removidos - migrados a CSS externo -->
    <link rel="stylesheet" href="css/loading-states-improved.css">
    <link rel="stylesheet" href="css/micro-interactions.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/notifications.css">
    <link rel="stylesheet" href="css/comparator.css?v=1.0">
    <link rel="stylesheet" href="css/breadcrumbs.css?v=1.0">
    <link rel="stylesheet" href="css/blog-compare.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/animations-enhanced.css">
    <link rel="stylesheet" href="css/components-enhanced.css">
    <link rel="stylesheet" href="css/typography.css">
    <link rel="stylesheet" href="css/product-cards.css">
</head>
<body>

    <!-- Header Dinámico -->
    <header id="mainHeader"></header>

    <nav id="breadcrumbs"></nav>

    <!-- Compare Page -->
    <section class="compare-page">
        <div class="compare-container">
            <div class="compare-header">
                <div class="compare-header-main">
                    <h1><i class="fas fa-balance-scale"></i> Comparar Productos</h1>
                    <p>Compara hasta 3 productos lado a lado</p>
                </div>
                <div class="compare-actions" id="compareActions" hidden>
                    <button class="btn btn-outline btn-sm" id="toggleDifferences">
                        <i class="fas fa-adjust"></i> Mostrar solo diferencias
                    </button>
                    <button class="btn btn-outline btn-sm" id="copyShareLink">
                        <i class="fas fa-link"></i> Compartir
                    </button>
                    <button class="btn btn-outline btn-sm" id="exportComparison">
                        <i class="fas fa-file-download"></i> Exportar CSV
                    </button>
                    <button class="btn btn-ghost btn-sm" id="clearComparison">
                        <i class="fas fa-trash"></i> Vaciar
                    </button>
                </div>
            </div>

            <div id="compareContent">
                <div class="loading">
                    <div class="loading-spinner large"></div>
                    <p>Cargando comparación...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer id="mainFooter"></footer>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/components.js"></script>
    <script src="js/modals.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/comparator.js"></script>
    <script src="js/breadcrumbs.js"></script>
    
    <script>
        (function () {
            const state = {
                highlightDifferences: false,
                products: [],
                sections: []
            };

            const currencyFormatter = new Intl.NumberFormat('es-PE', {
                style: 'currency',
                currency: 'PEN',
                minimumFractionDigits: 2
            });

            const compareContent = document.getElementById('compareContent');
            const actionsBar = document.getElementById('compareActions');
            const toggleDifferencesBtn = document.getElementById('toggleDifferences');
            const copyShareLinkBtn = document.getElementById('copyShareLink');
            const exportComparisonBtn = document.getElementById('exportComparison');
            const clearComparisonBtn = document.getElementById('clearComparison');

            document.addEventListener('DOMContentLoaded', async () => {
                initializeLayout();
                bindActions();
                await initializeFromQueryParams();
                await loadComparison();
            });

            document.addEventListener('productComparator:updated', () => {
                if (window.location.pathname.includes('compare.html')) {
                    loadComparison();
                }
            });

            function initializeLayout() {
                const headerContainer = document.getElementById('mainHeader');
                if (headerContainer && window.Components) {
                    headerContainer.innerHTML = window.Components.getHeader(true, true);
                    window.Components.initHeader();
                    window.Components.initSearch();
                    window.Components.initCartCounter();
                }

                const footerContainer = document.getElementById('mainFooter');
                if (footerContainer && window.Components) {
                    footerContainer.innerHTML = window.Components.getFooter();
                }
            }

            async function initializeFromQueryParams() {
                const params = new URLSearchParams(window.location.search);
                const idsParam = params.get('ids');
                if (!idsParam || !window.productComparator?.setProductsByIds) {
                    return;
                }

                const ids = idsParam.split(',').map(id => id.trim()).filter(Boolean);
                if (ids.length === 0) return;
                await window.productComparator.setProductsByIds(ids);
            }

            function bindActions() {
                if (toggleDifferencesBtn) {
                    toggleDifferencesBtn.addEventListener('click', () => {
                        state.highlightDifferences = !state.highlightDifferences;
                        toggleDifferencesBtn.classList.toggle('is-active', state.highlightDifferences);
                        toggleDifferencesBtn.innerHTML = state.highlightDifferences
                            ? '<i class="fas fa-adjust"></i> Mostrar todas'
                            : '<i class="fas fa-adjust"></i> Mostrar solo diferencias';
                        renderComparison();
                    });
                }

                if (copyShareLinkBtn) {
                    copyShareLinkBtn.addEventListener('click', copyShareLink);
                }

                if (exportComparisonBtn) {
                    exportComparisonBtn.addEventListener('click', exportComparisonCsv);
                }

                if (clearComparisonBtn) {
                    clearComparisonBtn.addEventListener('click', (event) => {
                        event.preventDefault();
                        window.productComparator?.clear?.();
                    });
                }
            }

            async function loadComparison() {
                const comparatorProducts = window.productComparator?.getProducts?.() || [];

                if (!comparatorProducts.length) {
                    state.products = [];
                    state.sections = [];
                    renderEmptyState();
                    return;
                }

                renderLoading();

                const detailedProducts = await Promise.all(
                    comparatorProducts.map(async (product) => {
                        try {
                            const response = await window.api.getProductById(product.id);
                            return response.success ? response.data.product : null;
                        } catch (error) {
                            console.error('Error loading product for comparison:', error);
                            return null;
                        }
                    })
                );

                const validProducts = detailedProducts.filter(Boolean);

                if (!validProducts.length) {
                    renderErrorState();
                    return;
                }

                state.products = validProducts;
                state.sections = buildComparisonSections(validProducts);
                renderComparison();
            }

            function renderLoading() {
                compareContent.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner large"></div>
                        <p>Cargando comparación...</p>
                    </div>
                `;
            }

            function renderEmptyState() {
                compareContent.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-balance-scale"></i>
                        <h3>No hay productos para comparar</h3>
                        <p>Agrega productos desde la página de productos para compararlos</p>
                        <a href="products.html" class="btn-browse">
                            <i class="fas fa-shopping-bag"></i> Ver Productos
                        </a>
                    </div>
                `;
                if (actionsBar) actionsBar.hidden = true;
            }

            function renderErrorState() {
                compareContent.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error al cargar productos</h3>
                        <p>No se pudieron cargar los productos para comparar</p>
                        <a href="products.html" class="btn-browse">
                            <i class="fas fa-shopping-bag"></i> Ver Productos
                        </a>
                    </div>
                `;
                if (actionsBar) actionsBar.hidden = true;
            }

            function renderComparison() {
                if (!state.products.length) {
                    renderEmptyState();
                    return;
                }

                if (actionsBar) {
                    actionsBar.hidden = false;
                    toggleDifferencesBtn?.classList.toggle('is-active', state.highlightDifferences);
                }

                const filteredSections = state.sections.map(section => ({
                    ...section,
                    rows: section.rows.filter(row => !state.highlightDifferences || row.isDifferent)
                })).filter(section => section.rows.length > 0);

                compareContent.innerHTML = `
                    <div class="compare-table">
                        <table>
                            <thead>
                                <tr>
                                    <th class="product-column">Producto</th>
                                    ${state.products.map(product => `
                                        <th>
                                            <div class="product-card">
                                                <img src="${product.image_url || 'https://via.placeholder.com/200'}"
                                                     alt="${escapeHTML(product.name)}"
                                                     class="product-image">
                                                <div class="product-name" title="${escapeHTML(product.name)}">${escapeHTML(product.name)}</div>
                                                <div class="product-price">
                                                    ${renderPrice(product)}
                                                </div>
                                                <div class="product-metadata">
                                                    ${renderRating(product)}
                                                </div>
                                                <div class="product-actions d-flex flex-col gap-sm">
                                                    <button class="btn btn-primary btn-sm" data-action="compare-add-cart" data-product-id="${product.id}">
                                                        <i class="fas fa-shopping-cart"></i> Agregar al Carrito
                                                    </button>
                                                    <button class="btn btn-outline btn-sm" data-action="compare-add-wishlist" data-product-id="${product.id}">
                                                        <i class="fas fa-heart"></i> Agregar a Wishlist
                                                    </button>
                                                    <button class="btn btn-error btn-sm" data-action="compare-remove" data-product-id="${product.id}">
                                                        <i class="fas fa-times"></i> Eliminar
                                                    </button>
                                                </div>
                                            </div>
                                        </th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredSections.map(section => `
                                    <tr class="section-row">
                                        <td colspan="${state.products.length + 1}">${escapeHTML(section.title)}</td>
                                    </tr>
                                    ${section.rows.map(row => `
                                        <tr class="${row.isDifferent ? 'is-different' : 'is-equal'}">
                                            <td class="spec-label">${escapeHTML(row.label)}</td>
                                            ${row.displayValues.map((value, index) => `
                                                <td class="spec-value ${row.isDifferent ? 'spec-value-different' : ''}">
                                                    ${value}
                                                </td>
                                            `).join('')}
                                        </tr>
                                    `).join('')}
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                compareContent.querySelectorAll('[data-action="compare-add-cart"]').forEach(button => {
                    button.addEventListener('click', () => addToCart(button.dataset.productId));
                });

                compareContent.querySelectorAll('[data-action="compare-add-wishlist"]').forEach(button => {
                    button.addEventListener('click', () => addToWishlist(button.dataset.productId));
                });

                compareContent.querySelectorAll('[data-action="compare-remove"]').forEach(button => {
                    button.addEventListener('click', () => removeFromComparison(button.dataset.productId));
                });
            }

            function renderPrice(product) {
                const price = safeNumber(product.price);
                const discountPrice = safeNumber(product.discount_price);

                if (discountPrice && discountPrice < price) {
                    const discountPercent = Math.round(((price - discountPrice) / price) * 100);
                    return `
                        <span class="product-price-old">${currencyFormatter.format(price)}</span>
                        ${currencyFormatter.format(discountPrice)}
                        <span class="product-price-discount">-${discountPercent}%</span>
                    `;
                }
                return price ? currencyFormatter.format(price) : '—';
            }

            function renderRating(product) {
                const rating = safeNumber(product.rating);
                if (!rating) {
                    return '<span class="product-rating muted">Sin calificaciones</span>';
                }
                const reviews = Number(product.review_count) || 0;
                return `<span class="product-rating"><i class="fas fa-star"></i> ${rating.toFixed(1)} (${reviews})</span>`;
            }

            function buildComparisonSections(products) {
                const sections = [];

                const generalRows = [
                    createRow('Precio', (product) => safeNumber(product.discount_price) || safeNumber(product.price), {
                        formatter: value => value ? currencyFormatter.format(value) : '—'
                    }, products),
                    createRow('Precio sin descuento', product => safeNumber(product.discount_price) ? safeNumber(product.price) : null, {
                        formatter: value => value ? currencyFormatter.format(value) : '—',
                        hideIfEmpty: true
                    }, products),
                    createRow('Descuento', product => {
                        const price = safeNumber(product.price);
                        const discountPrice = safeNumber(product.discount_price);
                        if (price && discountPrice && discountPrice < price) {
                            return Math.round(((price - discountPrice) / price) * 100) + '%';
                        }
                        return null;
                    }, { hideIfEmpty: true }, products),
                    createRow('Disponibilidad', product => product.stock_quantity > 0 ? `${product.stock_quantity} disponibles` : 'Agotado', {}, products),
                    createRow('Categoría', product => product.category_name, {}, products),
                    createRow('Marca', product => product.brand, {}, products),
                    createRow('SKU', product => product.sku, { hideIfEmpty: true }, products),
                    createRow('Peso', product => product.weight, { hideIfEmpty: true }, products),
                    createRow('Dimensiones', product => product.dimensions, { hideIfEmpty: true }, products),
                    createRow('Calificación promedio', product => {
                        const rating = safeNumber(product.rating);
                        if (!rating) return null;
                        const reviews = Number(product.review_count) || 0;
                        return `${rating.toFixed(1)} / 5 (${reviews} reseñas)`;
                    }, { hideIfEmpty: true }, products)
                ].filter(Boolean);

                if (generalRows.length) {
                    sections.push({ title: 'Información general', rows: generalRows });
                }

                const specificationRows = buildSpecificationRows(products);
                if (specificationRows.length) {
                    sections.push({ title: 'Especificaciones técnicas', rows: specificationRows });
                }

                const featureRows = [
                    createRow('Características destacadas', product => {
                        if (Array.isArray(product.features)) {
                            return product.features.filter(Boolean).map(item => item.trim());
                        }
                        if (typeof product.features === 'string') {
                            return product.features.split(/\r?\n|•|-|\*/).map(item => item.trim()).filter(Boolean);
                        }
                        return null;
                    }, { type: 'list', hideIfEmpty: true }, products),
                    createRow('Descripción', product => product.description, {
                        formatter: value => value ? escapeHTML(truncate(value, 240)) : '—',
                        hideIfEmpty: true
                    }, products)
                ].filter(Boolean);

                if (featureRows.length) {
                    sections.push({ title: 'Detalles y descripción', rows: featureRows });
                }

                return sections;
            }

            function buildSpecificationRows(products) {
                const keys = new Set();

                products.forEach(product => {
                    const specifications = product.specifications || {};
                    Object.keys(specifications || {}).forEach(key => keys.add(key));
                });

                return Array.from(keys).map((key) => createRow(formatLabel(key), product => {
                    const specifications = product.specifications || {};
                    return specifications[key] ?? null;
                }, { hideIfEmpty: true }, products));
            }

            function createRow(label, getter, options = {}, sourceProducts = state.products) {
                const rawValues = sourceProducts.map(product => getter(product));
                const hasContent = rawValues.some(value => value !== null && value !== undefined && value !== '' && !(Array.isArray(value) && value.length === 0));
                if (!hasContent && options.hideIfEmpty) return null;

                const plainValues = rawValues.map(value => {
                    if (Array.isArray(value)) {
                        return value.join('; ');
                    }
                    if (value === null || value === undefined || value === '') return '—';
                    if (typeof value === 'number') return value.toString();
                    return String(value);
                });

                const displayValues = rawValues.map(value => formatValue(value, options));

                const normalizedValues = plainValues.map(value => normalizeValue(value));
                const first = normalizedValues[0];
                const isDifferent = normalizedValues.some(value => value !== first);

                return {
                    key: options.key || label,
                    label,
                    rawValues,
                    plainValues,
                    displayValues,
                    isDifferent
                };
            }

            function formatValue(value, options = {}) {
                if (Array.isArray(value) && value.length) {
                    return `
                        <ul class="feature-list">
                            ${value.map(item => `<li>${escapeHTML(item)}</li>`).join('')}
                        </ul>
                    `;
                }

                if (typeof value === 'number') {
                    if (options.formatter) {
                        return options.formatter(value);
                    }
                    return escapeHTML(value.toString());
                }

                if (value === null || value === undefined || value === '') {
                    return '—';
                }

                if (options.formatter) {
                    return options.formatter(value);
                }

                return escapeHTML(String(value));
            }

            function normalizeValue(value) {
                if (typeof value === 'string') {
                    return value.trim().toLowerCase();
                }
                if (Array.isArray(value)) {
                    return value.map(item => normalizeValue(item)).join('|');
                }
                if (value === null || value === undefined) {
                    return '';
                }
                return String(value);
            }

            function formatLabel(key) {
                return key
                    .replace(/_/g, ' ')
                    .replace(/\b\w/g, char => char.toUpperCase());
            }

            function truncate(text, length) {
                if (!text) return '';
                if (text.length <= length) return text;
                return `${text.substring(0, length)}…`;
            }

            function safeNumber(value) {
                const number = Number(value);
                return Number.isFinite(number) ? number : null;
            }

            function escapeHTML(value) {
                return value
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            async function addToCart(productId) {
                try {
                    await window.cartManager?.add?.(productId, 1);
                    window.notifications?.success?.('Producto agregado al carrito');
                } catch (error) {
                    console.error('Error adding product to cart:', error);
                    window.notifications?.error?.('Error al agregar al carrito');
                }
            }

            async function addToWishlist(productId) {
                try {
                    if (window.wishlistManager?.toggle) {
                        await window.wishlistManager.toggle(productId);
                    } else {
                        await window.api.addToWishlist(productId);
                    }
                } catch (error) {
                    console.error('Error adding product to wishlist:', error);
                    window.notifications?.error?.('Error al agregar a favoritos');
                }
            }

            function removeFromComparison(productId) {
                window.productComparator?.removeProduct?.(productId);
            }

            async function copyShareLink() {
                const ids = window.productComparator?.getProductIds?.() || [];
                if (!ids.length) {
                    window.notifications?.warning?.('Agrega productos para compartir la comparación');
                    return;
                }

                const shareUrl = `${window.location.origin}${window.location.pathname}?ids=${encodeURIComponent(ids.join(','))}`;

                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'Comparativa FutureLabs',
                            text: 'Mira esta comparativa de productos FutureLabs',
                            url: shareUrl
                        });
                        return;
                    } catch (error) {
                        console.log('Web Share API falló, intentando copiar...', error);
                    }
                }

                try {
                    await navigator.clipboard.writeText(shareUrl);
                    window.notifications?.success?.('Enlace copiado al portapapeles');
                } catch (error) {
                    console.error('Clipboard error:', error);
                    window.notifications?.info?.(`Copia este enlace:\n${shareUrl}`);
                }
            }

            function exportComparisonCsv() {
                if (!state.sections.length || !state.products.length) {
                    window.notifications?.warning?.('Agrega productos para exportar la comparación');
                    return;
                }

                const rows = [];
                const header = ['Característica', ...state.products.map(product => product.name)];
                rows.push(header);

                state.sections.forEach(section => {
                    const filteredRows = section.rows.filter(row => !state.highlightDifferences || row.isDifferent);
                    if (!filteredRows.length) return;

                    rows.push([section.title]);
                    filteredRows.forEach(row => {
                        rows.push([row.label, ...row.plainValues]);
                    });
                    rows.push([]);
                });

                const csvContent = rows
                    .map(row => row.map(value => `"${String(value ?? '').replace(/"/g, '""')}"`).join(','))
                    .join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `comparacion-futurelabs-${Date.now()}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                window.notifications?.success?.('Comparación exportada en CSV');
            }
        })();
    </script>
</body>
</html>


