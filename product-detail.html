<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Producto - FutureLabs</title>
    
    <!-- Google Fonts - Fuentes Profesionales -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/header-improved.css">
    <link rel="stylesheet" href="css/footer-improved.css">
    <link rel="stylesheet" href="css/forms-improved.css">
    <link rel="stylesheet" href="css/modals-improved.css">
    <link rel="stylesheet" href="css/pages-common.css">
    <link rel="stylesheet" href="css/product-detail-page.css">
    <link rel="stylesheet" href="css/loading-states-improved.css">
    <link rel="stylesheet" href="css/micro-interactions.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/notifications.css">
    <link rel="stylesheet" href="css/reviews.css">
    <link rel="stylesheet" href="css/home-link-fix.css?v=2.0">
    <!-- Estilos inline removidos - migrados a product-detail-page.css -->
</head>
<body>
    <!-- Header Dinámico -->
    <header id="mainHeader"></header>

    <!-- Product Detail Page -->
    <div class="product-detail-page">
<div class="container">
    <div id="productDetailContainer">
        <div class="loading-detail">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <p>Cargando producto...</p>
        </div>
    </div>
</div>

<!-- Reviews Section -->
<div class="container">
    <div id="reviewsContainer"></div>
</div>
    </div>

    <!-- Scripts -->
    <!-- Scripts del Sistema Integrado -->
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/skeleton.js"></script>
    <script src="js/modals.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/reviews.js"></script>
    <script src="js/related-products.js"></script>
    <script src="js/components.js"></script>
    <script src="js/fix-home-link.js"></script>
    
    <script>
// Inicializar header dinámico y cargar producto
document.addEventListener('DOMContentLoaded', async function() {
    // Inicializar header
    const headerContainer = document.getElementById('mainHeader');
    if (headerContainer && window.Components) {
        headerContainer.innerHTML = window.Components.getHeader(false, false);
        window.Components.initHeader();
    }
    
    // Obtener ID del producto de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');

    // Cargar reseñas
    async function loadReviews() {
        const container = document.getElementById('reviewsContainer');
        if (!container) return;
        
        try {
            const { reviews, stats } = await window.reviewsManager.loadReviews(productId);
            window.reviewsManager.renderReviews(container, productId);
        } catch (error) {
            console.error('Error loading reviews:', error);
        }
    }

    // Cargar producto
    async function loadProduct() {
        const container = document.getElementById('productDetailContainer');
        
        if (!productId) {
            container.innerHTML = `
            <div style="text-align: center; padding: 100px;">
                <i class="fas fa-exclamation-triangle fa-3x" style="color: #e74c3c; margin-bottom: 20px;"></i>
                <h2>Producto no encontrado</h2>
                <p>El producto que buscas no existe</p>
            </div>
        `;
        return;
    }

    try {
        const response = await window.api.getProduct(productId);
        
        if (response.success && response.data.product) {
            const product = response.data.product;
            
            // Normalizar la URL de la imagen
            let imageUrl = product.image_url || 'assets/images/products/placeholder.jpg';
            
            // Si la URL no comienza con http/https, verificar si es relativa o necesita el protocolo
            if (imageUrl && !imageUrl.startsWith('http://') && !imageUrl.startsWith('https://') && !imageUrl.startsWith('/')) {
                // Si es una URL del backend sin protocolo, agregar https://
                if (imageUrl.includes('railway.app') || imageUrl.includes('futurelabs')) {
                    imageUrl = `https://${imageUrl}`;
                }
            }
            
            // Si es una URL relativa que empieza con /uploads, convertir a URL completa del backend
            if (imageUrl.startsWith('/uploads/')) {
                imageUrl = `https://futurelabs-production.up.railway.app${imageUrl}`;
            }
            
            console.log('Product image URL:', imageUrl);
            
            container.innerHTML = `
                <div class="product-detail-container">
                    <div class="product-images">
                        <div class="main-image">
                            <img src="${imageUrl}" 
                                 alt="${product.name}"
                                 onerror="this.onerror=null; this.src='assets/images/products/placeholder.jpg';">
                        </div>
                    </div>
                    
                    <div class="product-info-detail">
                        <p class="product-brand-detail">${product.brand}</p>
                        <h1 class="product-title-detail">${product.name}</h1>
                        
                        <div class="product-rating-detail">
                            <span class="stars-detail">★★★★★</span>
                            <span class="rating-text-detail">${product.rating || 0}</span>
                            <span class="rating-count-detail">(${product.review_count || 0} reseñas)</span>
                        </div>
                        
                        <div class="product-price-detail">
                            <span class="current-price-detail">S/ ${product.price}</span>
                            ${product.discount_price < product.price ? `<span class="old-price-detail">S/ ${product.discount_price}</span>` : ''}
                        </div>
                        
                        <div class="product-description-detail">
                            ${product.description || 'Sin descripción disponible'}
                        </div>
                        
                        ${product.specifications ? `
                        <div class="product-specs-detail">
                            <h3 style="margin-bottom: 15px;">Especificaciones</h3>
                            ${Object.entries(product.specifications).map(([key, value]) => `
                                <div class="spec-item">
                                    <span class="spec-label">${key}:</span>
                                    <span class="spec-value">${value}</span>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        <div class="product-stock-detail ${product.stock_quantity > 0 ? 'in-stock-detail' : 'out-of-stock-detail'}">
                            <i class="fas fa-${product.stock_quantity > 0 ? 'check-circle' : 'times-circle'}"></i>
                            ${product.stock_quantity > 0 ? `En stock (${product.stock_quantity} disponibles)` : 'Agotado'}
                        </div>
                        
                        <div class="product-actions-detail d-flex gap-md">
                            <button class="btn btn-primary btn-lg" onclick="addToCart()" ${product.stock_quantity === 0 ? 'disabled' : ''}>
                                <i class="fas fa-shopping-cart"></i> Agregar al Carrito
                            </button>
                            <button class="btn btn-ghost btn-lg" onclick="addToFavorites()">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>
                        
                        <button class="btn btn-secondary btn-lg btn-full" onclick="buyNow()" ${product.stock_quantity === 0 ? 'disabled' : ''}>
                            <i class="fas fa-bolt"></i> Comprar Ahora
                        </button>
                    </div>
                </div>
            `;
            
            // Cargar reseñas
            await loadReviews();
        } else {
            container.innerHTML = `
                <div style="text-align: center; padding: 100px;">
                    <i class="fas fa-exclamation-triangle fa-3x" style="color: #e74c3c; margin-bottom: 20px;"></i>
                    <h2>Producto no encontrado</h2>
                    <p>El producto que buscas no existe</p>
                </div>
            `;
        }
    } catch (error) {
        container.innerHTML = `
            <div style="text-align: center; padding: 100px;">
                <i class="fas fa-exclamation-triangle fa-3x" style="color: #e74c3c; margin-bottom: 20px;"></i>
                <h2>Error al cargar el producto</h2>
                <p>${error.message}</p>
            </div>
        `;
    }
}

// Agregar al carrito
async function addToCart() {
    // Obtener ID del producto de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    
    if (!productId) {
        window.notifications.error('Error: ID de producto no encontrado');
        return;
    }
    
    await window.cartManager.add(productId, 1);
}

// Agregar a favoritos
function addToFavorites() {
    window.notifications.info('Funcionalidad de favoritos próximamente');
}

// Comprar ahora
async function buyNow() {
    // Obtener ID del producto de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    
    if (!productId) {
        window.notifications.error('Error: ID de producto no encontrado');
        return;
    }
    
    await window.cartManager.add(productId, 1);
    window.notifications.success('Redirigiendo al checkout...');
    setTimeout(() => {
        window.location.href = 'checkout.html';
    }, 1000);
}

    // Actualizar contador de carrito
    document.addEventListener('cartUpdated', (e) => {
        const cartCount = document.querySelector('.cart-count');
        if (cartCount) {
            cartCount.textContent = e.detail.count;
        }
    });

    // Cargar producto al iniciar
    await loadProduct();
});
    </script>
</body>
</html>

