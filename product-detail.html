<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Producto - FutureLabs</title>
    
    <!-- Google Fonts - Fuentes Profesionales -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/header-improved.css">
    <link rel="stylesheet" href="css/footer-improved.css">
    <link rel="stylesheet" href="css/forms-improved.css">
    <link rel="stylesheet" href="css/modals-improved.css">
    <link rel="stylesheet" href="css/pages-common.css">
    <link rel="stylesheet" href="css/product-detail-page.css">
    <link rel="stylesheet" href="css/loading-states-improved.css">
    <link rel="stylesheet" href="css/micro-interactions.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/notifications.css">
    <link rel="stylesheet" href="css/reviews.css">
    <link rel="stylesheet" href="css/product-gallery.css?v=1.0">
    <link rel="stylesheet" href="css/recently-viewed.css?v=1.0">
    <link rel="stylesheet" href="css/comparator.css?v=1.0">
    <link rel="stylesheet" href="css/breadcrumbs.css?v=1.0">
    <!-- Estilos inline removidos - migrados a product-detail-page.css -->
</head>
<body>
    <!-- Header Dinámico -->
    <header id="mainHeader"></header>
    
    <!-- Breadcrumbs -->
    <nav id="breadcrumbs"></nav>

    <!-- Product Detail Page -->
    <div class="product-detail-page">
<div class="container">
    <div id="productDetailContainer">
        <div class="loading-detail">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <p>Cargando producto...</p>
        </div>
    </div>
</div>

<!-- Recently Viewed Section -->
<section id="recentlyViewedSection" class="recently-viewed-section" data-recently-viewed-section style="display:none;">
    <div class="container">
        <div class="section-header">
            <h2><i class="fas fa-eye"></i> Productos que viste recientemente</h2>
            <button type="button" class="recently-viewed-clear" id="clearRecentlyViewedBtn">
                <i class="fas fa-times"></i> Limpiar historial
            </button>
        </div>
        <div id="recentlyViewedGrid" class="recently-viewed-grid" data-section="#recentlyViewedSection"></div>
    </div>
</section>

<!-- Reviews Section -->
<section class="reviews-section">
    <div class="container">
        <div class="reviews-header">
            <h2 class="reviews-title"><i class="fas fa-star"></i> Opiniones de clientes</h2>
            <button class="btn btn-outline btn-sm" type="button" id="writeReviewBtn">
                <i class="fas fa-pen"></i> Escribir review
            </button>
        </div>
        <div id="reviewsStats"></div>
        <div class="reviews-filters">
            <div class="filter-group">
                <span class="filter-label">Filtrar:</span>
                <div class="filter-buttons" id="reviewsFilterButtons">
                    <button class="filter-btn active" type="button" data-review-filter="all">Todas</button>
                    <button class="filter-btn" type="button" data-review-filter="5">5 ★</button>
                    <button class="filter-btn" type="button" data-review-filter="4">4 ★</button>
                    <button class="filter-btn" type="button" data-review-filter="3">3 ★</button>
                    <button class="filter-btn" type="button" data-review-filter="2">2 ★</button>
                    <button class="filter-btn" type="button" data-review-filter="1">1 ★</button>
                    <button class="filter-btn" type="button" data-review-filter="with-photos">
                        <i class="fas fa-camera"></i> Con fotos
                    </button>
                </div>
            </div>
            <div class="filter-group">
                <span class="filter-label">Ordenar:</span>
                <select id="reviewsSortSelect" class="form-input">
                    <option value="recent">Más recientes</option>
                    <option value="highest">Mejor calificados</option>
                    <option value="lowest">Peor calificados</option>
                    <option value="oldest">Más antiguos</option>
                </select>
            </div>
        </div>
        <div id="reviewFormContainer"></div>
        <div id="reviewsList"></div>
    </div>
</section>
    </div>

    <!-- Scripts -->
    <!-- Scripts del Sistema Integrado -->
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/skeleton.js"></script>
    <script src="js/modals.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/comparator.js"></script>
    <script src="js/recently-viewed.js"></script>
    <script src="js/reviews.js"></script>
    <script src="js/related-products.js"></script>
    <script src="js/components.js"></script>
    <script src="js/product-gallery.js"></script>
    <script src="js/breadcrumbs.js"></script>
    
    <script>
// Inicializar header dinámico y cargar producto
document.addEventListener('DOMContentLoaded', async function() {
    // Inicializar header
    const headerContainer = document.getElementById('mainHeader');
    if (headerContainer && window.Components) {
        headerContainer.innerHTML = window.Components.getHeader(true, true);
        window.Components.initHeader();
        window.Components.initSearch();
        window.Components.initCartCounter();
    }
    
    // Obtener ID del producto de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    window.currentProductId = productId;

    // Cargar producto
    async function loadProduct() {
        const container = document.getElementById('productDetailContainer');
        
        if (!productId) {
            container.innerHTML = `
            <div style="text-align: center; padding: 100px;">
                <i class="fas fa-exclamation-triangle fa-3x" style="color: #e74c3c; margin-bottom: 20px;"></i>
                <h2>Producto no encontrado</h2>
                <p>El producto que buscas no existe</p>
            </div>
        `;
        return;
    }

    try {
        const response = await window.api.getProduct(productId);
        
        if (response.success && response.data.product) {
            const product = response.data.product;
            
            // Normalizar la URL de la imagen
            let imageUrl = product.image_url || 'assets/images/products/placeholder.jpg';
            
            // Si la URL no comienza con http/https, verificar si es relativa o necesita el protocolo
            if (imageUrl && !imageUrl.startsWith('http://') && !imageUrl.startsWith('https://') && !imageUrl.startsWith('/')) {
                // Si es una URL del backend sin protocolo, agregar https://
                if (imageUrl.includes('railway.app') || imageUrl.includes('futurelabs')) {
                    imageUrl = `https://${imageUrl}`;
                }
            }
            
            // Si es una URL relativa que empieza con /uploads, convertir a URL completa del backend
            if (imageUrl.startsWith('/uploads/')) {
                imageUrl = `https://futurelabs-production.up.railway.app${imageUrl}`;
            }
            
            console.log('Product image URL:', imageUrl);
            product.image_url = imageUrl;
            
            // Generar múltiples imágenes para la galería
            let galleryImages = [];
            if (product.gallery_images && product.gallery_images.length > 0) {
              galleryImages = product.gallery_images;
            } else {
              // Si solo hay una imagen, duplicarla para mejor UX
              galleryImages = [imageUrl, imageUrl, imageUrl, imageUrl];
            }
            
            // Guardar producto globalmente para breadcrumbs
            window.currentProduct = product;
            if (window.breadcrumbs) {
              window.breadcrumbs.updateProductName(product.name);
            }
            
            container.innerHTML = `
                <div class="product-detail-container">
                    <div id="productGallery">
                        <!-- Galería se renderizará aquí -->
                    </div>
                    
                    <div class="product-info-detail">
                        <p class="product-brand-detail">${product.brand}</p>
                        <h1 class="product-title-detail">${product.name}</h1>
                        
                        <div class="product-rating-detail">
                            <span class="stars-detail">★★★★★</span>
                            <span class="rating-text-detail">${product.rating || 0}</span>
                            <span class="rating-count-detail">(${product.review_count || 0} reseñas)</span>
                        </div>
                        
                        <div class="product-price-detail">
                            <span class="current-price-detail">S/ ${product.price}</span>
                            ${product.discount_price < product.price ? `<span class="old-price-detail">S/ ${product.discount_price}</span>` : ''}
                        </div>
                        
                        <div class="product-description-detail">
                            ${product.description || 'Sin descripción disponible'}
                        </div>
                        
                        ${product.specifications ? `
                        <div class="product-specs-detail">
                            <h3 style="margin-bottom: 15px;">Especificaciones</h3>
                            ${Object.entries(product.specifications).map(([key, value]) => `
                                <div class="spec-item">
                                    <span class="spec-label">${key}:</span>
                                    <span class="spec-value">${value}</span>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        <div class="product-stock-detail ${product.stock_quantity > 0 ? 'in-stock-detail' : 'out-of-stock-detail'}">
                            <i class="fas fa-${product.stock_quantity > 0 ? 'check-circle' : 'times-circle'}"></i>
                            ${product.stock_quantity > 0 ? `En stock (${product.stock_quantity} disponibles)` : 'Agotado'}
                        </div>
                        
                        <div class="product-actions-detail d-flex gap-md">
                            <button class="btn btn-primary btn-lg" onclick="addToCart()" ${product.stock_quantity === 0 ? 'disabled' : ''}>
                                <i class="fas fa-shopping-cart"></i> Agregar al Carrito
                            </button>
                            <button
                                class="btn btn-ghost btn-lg"
                                type="button"
                                data-wishlist-toggle
                                data-product-id="${product.id}"
                                data-label-inactive="Agregar a favoritos"
                                data-label-active="En tu wishlist"
                                data-icon-inactive="far fa-heart"
                                data-icon-active="fas fa-heart"
                            >
                                <i class="far fa-heart"></i>
                            </button>
                            <button class="btn btn-outline btn-lg btn-compare" data-product-id="${product.id}" data-label-inactive="Comparar" data-label-active="Comparando" title="Comparar producto">
                                <i class="fas fa-balance-scale"></i> Comparar
                            </button>
                        </div>
                        
                        <button class="btn btn-secondary btn-lg btn-full" onclick="buyNow()" ${product.stock_quantity === 0 ? 'disabled' : ''}>
                            <i class="fas fa-bolt"></i> Comprar Ahora
                        </button>
                    </div>
                </div>
            `;

            if (window.productComparator) {
              window.productComparator.updateCompareButtons();
            }
            
            if (window.productGallery && galleryImages) {
              window.productGallery.render(galleryImages, product);
            }

            if (window.wishlistManager) {
              window.wishlistManager.syncToggleButtons(container);
            }

            if (window.recentlyViewed) {
              window.recentlyViewed.add({
                id: product.id,
                name: product.name,
                brand: product.brand,
                price: product.price,
                discount_price: product.discount_price,
                image_url: product.image_url
              });
              window.recentlyViewed.render('recentlyViewedGrid', { limit: 6, hideWhenEmpty: true });
            }
        } else {
            container.innerHTML = `
                <div style="text-align: center; padding: 100px;">
                    <i class="fas fa-exclamation-triangle fa-3x" style="color: #e74c3c; margin-bottom: 20px;"></i>
                    <h2>Producto no encontrado</h2>
                    <p>El producto que buscas no existe</p>
                </div>
            `;
        }
    } catch (error) {
        container.innerHTML = `
            <div style="text-align: center; padding: 100px;">
                <i class="fas fa-exclamation-triangle fa-3x" style="color: #e74c3c; margin-bottom: 20px;"></i>
                <h2>Error al cargar el producto</h2>
                <p>${error.message}</p>
            </div>
        `;
    }
}

// Agregar al carrito
async function addToCart() {
    // Obtener ID del producto de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    
    if (!productId) {
        window.notifications.error('Error: ID de producto no encontrado');
        return;
    }
    
    await window.cartManager.add(productId, 1);
}

// Comprar ahora
async function buyNow() {
    // Obtener ID del producto de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    
    if (!productId) {
        window.notifications.error('Error: ID de producto no encontrado');
        return;
    }
    
    await window.cartManager.add(productId, 1);
    window.notifications.success('Redirigiendo al checkout...');
    setTimeout(() => {
        window.location.href = 'checkout.html';
    }, 1000);
}

    const clearRecentlyViewedBtn = document.getElementById('clearRecentlyViewedBtn');
    if (clearRecentlyViewedBtn) {
        clearRecentlyViewedBtn.addEventListener('click', () => {
            window.recentlyViewed?.clearAndRender('recentlyViewedGrid', { hideWhenEmpty: true });
        });
    }

    if (window.recentlyViewed) {
        window.recentlyViewed.render('recentlyViewedGrid', { limit: 6, hideWhenEmpty: true });
    }

    // Actualizar contador de carrito
    document.addEventListener('cartUpdated', (e) => {
        const cartCount = document.querySelector('.cart-count');
        if (cartCount) {
            cartCount.textContent = e.detail.count;
        }
    });

    // Cargar producto al iniciar
    await loadProduct();

    if (productId && window.reviewsManager) {
        await window.reviewsManager.init(productId, {
            statsContainerId: 'reviewsStats',
            listContainerId: 'reviewsList',
            formContainerId: 'reviewFormContainer',
            filterContainerId: 'reviewsFilterButtons',
            sortSelectId: 'reviewsSortSelect',
            writeButtonId: 'writeReviewBtn'
        });
    }
});
    </script>
</body>
</html>

