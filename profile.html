<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - FutureLabs</title>
    
    <!-- Google Fonts - Fuentes Profesionales -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CSS del Sistema -->
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/header-improved.css">
    <link rel="stylesheet" href="css/footer-improved.css">
    <link rel="stylesheet" href="css/forms-improved.css">
    <link rel="stylesheet" href="css/modals-improved.css">
    <link rel="stylesheet" href="css/pages-common.css">
    <link rel="stylesheet" href="css/profile-wishlist-orders.css">
    <link rel="stylesheet" href="css/loading-states-improved.css">
    <link rel="stylesheet" href="css/micro-interactions.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/animations-enhanced.css">
    <link rel="stylesheet" href="css/components-enhanced.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/notifications.css">
    <!-- CARGAR STYLE.CSS ANTES DEL FIX PARA EVITAR SOBRESCRITURA -->
    <link rel="stylesheet" href="css/style.css">
    
</head>
<body>
    <!-- Header Din√°mico -->
    <header id="mainHeader"></header>

    <!-- Profile Page -->
    <div class="profile-page">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="container">
                <div class="profile-header-content">
                    <div class="profile-avatar" id="profileAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="profile-info">
                        <h1 id="profileName">Cargando...</h1>
                        <p id="profileEmail">Cargando email...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Profile Tabs -->
            <div class="profile-tabs">
                <button class="profile-tab active" data-tab="overview">
                    <i class="fas fa-home"></i>
                    <span>Resumen</span>
                </button>
                <button class="profile-tab" data-tab="personal">
                    <i class="fas fa-user"></i>
                    <span>Datos Personales</span>
                </button>
                <button class="profile-tab" data-tab="addresses">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Direcciones</span>
                </button>
                <button class="profile-tab" data-tab="security">
                    <i class="fas fa-lock"></i>
                    <span>Seguridad</span>
                </button>
                <button class="profile-tab" data-tab="points">
                    <i class="fas fa-star"></i>
                    <span>Puntos de Lealtad</span>
                </button>
            </div>

            <!-- Profile Content Sections -->
            <div class="profile-content-wrapper">
                <!-- Overview Tab -->
                <div class="profile-section active" id="overview">
                    <!-- Loyalty Points Overview -->
                    <div class="loyalty-overview-grid">
                        <div class="loyalty-points-card">
                            <div class="loyalty-card-header">
                                <div class="loyalty-tier-chip" id="loyaltyTierChip">
                                    <i class="fas fa-medal"></i>
                                    <span id="loyaltyTierName">Explorador</span>
                                </div>
                                <button type="button" class="btn btn-light btn-sm loyalty-redeem-btn" id="loyaltyRedeemButton">
                                    <i class="fas fa-gift"></i> Canjear puntos
                                </button>
                            </div>
                            <div class="loyalty-card-body">
                                <div class="loyalty-points-group">
                                    <span class="loyalty-points-label">Puntos disponibles</span>
                                    <div class="loyalty-points-value" id="loyaltyPointsValue">0</div>
                                </div>
                                <div class="loyalty-points-meta">
                                    <div>
                                        <span class="loyalty-meta-label">Equivalen a</span>
                                        <span class="loyalty-meta-value" id="loyaltyPointsEquivalent">S/ 0.00</span>
                                    </div>
                                    <div>
                                        <span class="loyalty-meta-label">Multiplicador actual</span>
                                        <span class="loyalty-meta-value" id="loyaltyPointsMultiplier">1.0x</span>
                                    </div>
                                </div>
                            </div>
                            <div class="loyalty-progress">
                                <div class="loyalty-progress-header">
                                    <span id="loyaltyProgressLabel">Sigue acumulando para subir de nivel</span>
                                    <span id="loyaltyProgressPercent">0%</span>
                                </div>
                                <div class="loyalty-progress-bar">
                                    <div class="loyalty-progress-fill" id="loyaltyProgressFill"></div>
                                </div>
                            </div>
                            <div class="loyalty-benefits">
                                <h3>Beneficios actuales</h3>
                                <ul id="loyaltyBenefitsList">
                                    <li><i class="fas fa-check-circle"></i> 1x puntos por cada S/ 1</li>
                                </ul>
                            </div>
                        </div>

                        <div class="loyalty-actions-card">
                            <h3>C√≥mo ganar m√°s puntos</h3>
                            <p class="loyalty-next-tier" id="loyaltyNextTierMessage">Realiza tu pr√≥xima compra para desbloquear beneficios.</p>
                            <ul class="loyalty-actions-list">
                                <li><i class="fas fa-shopping-bag"></i> Compra en la tienda (+1 punto por S/ 1)</li>
                                <li><i class="fas fa-star"></i> Deja una rese√±a verificada (+150 pts)</li>
                                <li><i class="fas fa-user-friends"></i> Invita a un amigo que compre (+250 pts)</li>
                                <li><i class="fas fa-bolt"></i> Aprovecha campa√±as con doble puntos</li>
                            </ul>
                            <button type="button" class="btn btn-outline btn-sm" id="loyaltyLearnMoreButton">
                                <i class="fas fa-info-circle"></i> Ver todas las recompensas
                            </button>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <span class="stat-card-title">Pedidos</span>
                                <div class="stat-card-icon" style="background: rgba(102, 126, 234, 0.1); color: #667eea;">
                                    <i class="fas fa-shopping-bag"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="totalOrders">0</div>
                            <div class="stat-card-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>Total de pedidos</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-card-header">
                                <span class="stat-card-title">Gastado</span>
                                <div class="stat-card-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="totalSpent">S/ 0</div>
                            <div class="stat-card-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>Total acumulado</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-card-header">
                                <span class="stat-card-title">Wishlist</span>
                                <div class="stat-card-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                                    <i class="fas fa-heart"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="wishlistCount">0</div>
                            <div class="stat-card-change positive">
                                <i class="fas fa-heart"></i>
                                <span>Productos favoritos</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-card-header">
                                <span class="stat-card-title">Rese√±as</span>
                                <div class="stat-card-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                                    <i class="fas fa-star"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="reviewsCount">0</div>
                            <div class="stat-card-change positive">
                                <i class="fas fa-star"></i>
                                <span>Rese√±as realizadas</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Personal Data Tab -->
                <div class="profile-section" id="personal">
                    <div class="profile-content-section">
                        <div class="profile-content-section-header">
                            <h2><i class="fas fa-user"></i> Informaci√≥n Personal</h2>
                        </div>
                        <form id="personalDataForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Nombre</label>
                                    <input type="text" class="form-input" id="firstName" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Apellidos</label>
                                    <input type="text" class="form-input" id="lastName" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="email" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tel√©fono</label>
                                <input type="tel" class="form-input" id="phone">
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="cancelEdit('personal')">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Addresses Tab -->
                <div class="profile-section" id="addresses">
                    <div class="profile-content-section">
                        <div class="profile-content-section-header">
                            <h2><i class="fas fa-map-marker-alt"></i> Mis Direcciones</h2>
                            <button class="btn btn-primary" onclick="openAddressModal()">
                                <i class="fas fa-plus"></i> Nueva Direcci√≥n
                            </button>
                        </div>
                        <div id="addressesList" class="address-list"></div>
                    </div>
                </div>

                <!-- Security Tab -->
                <div class="profile-section" id="security">
                    <div class="profile-content-section">
                        <div class="profile-content-section-header">
                            <h2><i class="fas fa-lock"></i> Seguridad</h2>
                        </div>
                        <form id="changePasswordForm">
                            <div class="form-group">
                                <label class="form-label">Contrase√±a Actual</label>
                                <input type="password" class="form-input" id="currentPassword" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nueva Contrase√±a</label>
                                <input type="password" class="form-input" id="newPassword" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirmar Nueva Contrase√±a</label>
                                <input type="password" class="form-input" id="confirmPassword" required>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="cancelEdit('security')">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Cambiar Contrase√±a</button>
                            </div>
                        </form>
                        
                        <!-- Logout Section -->
                        <div class="profile-content-section" style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 30px;">
                            <div class="profile-content-section-header">
                                <h3><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</h3>
                                <p style="color: var(--gray-600); font-size: 0.9rem; margin-top: 8px;">Cierra tu sesi√≥n de forma segura en este dispositivo</p>
                            </div>
                            <button type="button" id="logoutButton" class="btn btn-danger" style="margin-top: 20px;">
                                <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Points Tab -->
                <div class="profile-section" id="points">
                    <div class="profile-content-section">
                        <div class="profile-content-section-header">
                            <h2><i class="fas fa-star"></i> Historial de Puntos</h2>
                        </div>
                        <div id="loyaltyTransactions" class="loyalty-transactions"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer id="mainFooter"></footer>

    <!-- Address Modal -->
    <div id="addressModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="addressModalTitle">Nueva Direcci√≥n</h3>
                <span class="modal-close" onclick="closeAddressModal()">&times;</span>
            </div>
            <form id="addressForm">
                <input type="hidden" id="addressId">
                <div class="form-group">
                    <label class="form-label">Tipo de Direcci√≥n</label>
                    <select class="form-select" id="addressType" required>
                        <option value="home">Casa</option>
                        <option value="work">Trabajo</option>
                        <option value="other">Otra</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Direcci√≥n</label>
                    <input type="text" class="form-input" id="addressStreet" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Ciudad</label>
                        <input type="text" class="form-input" id="addressCity" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Regi√≥n</label>
                        <input type="text" class="form-input" id="addressRegion" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">C√≥digo Postal</label>
                        <input type="text" class="form-input" id="addressPostalCode">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pa√≠s</label>
                        <input type="text" class="form-input" id="addressCountry" value="Per√∫" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="addressIsDefault"> 
                        Establecer como direcci√≥n predeterminada
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddressModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Direcci√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/skeleton.js"></script>
    <script src="js/modals.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/components.js"></script>
    
    <script>
        // Logging inicial para verificar que el script se carga
        console.log('üîµ [PROFILE] Script profile.html cargado');
        
        const LOYALTY_POINTS_TO_CURRENCY_RATE = 10;
        const LOYALTY_TIERS = [
            {
                id: 'bronze',
                name: 'Bronce',
                min: 0,
                multiplier: 1,
                icon: 'fas fa-medal',
                gradient: 'linear-gradient(135deg, #b87333 0%, #d97706 100%)',
                chipBackground: 'rgba(184, 115, 51, 0.35)',
                chipColor: '#fff7ed',
                textColor: '#ffffff',
                benefits: [
                    '1x puntos por cada S/ 1',
                    'Acceso a campa√±as especiales'
                ]
            },
            {
                id: 'silver',
                name: 'Plata',
                min: 500,
                multiplier: 1.25,
                icon: 'fas fa-trophy',
                gradient: 'linear-gradient(135deg, #9ca3af 0%, #cbd5f5 100%)',
                chipBackground: 'rgba(148, 163, 184, 0.35)',
                chipColor: '#0f172a',
                textColor: '#0f172a',
                benefits: [
                    '1.25x puntos por cada S/ 1',
                    'Env√≠o est√°ndar gratis en compras mayores a S/ 250',
                    'Atenci√≥n prioritaria en soporte'
                ]
            },
            {
                id: 'gold',
                name: 'Oro',
                min: 1200,
                multiplier: 1.5,
                icon: 'fas fa-crown',
                gradient: 'linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%)',
                chipBackground: 'rgba(251, 191, 36, 0.45)',
                chipColor: '#78350f',
                textColor: '#78350f',
                benefits: [
                    '1.5x puntos por cada S/ 1',
                    'Ofertas exclusivas antes que todos',
                    'Regalo sorpresa cada trimestre'
                ]
            },
            {
                id: 'platinum',
                name: 'Platino',
                min: 2000,
                multiplier: 2,
                icon: 'fas fa-gem',
                gradient: 'linear-gradient(135deg, #4f46e5 0%, #a855f7 100%)',
                chipBackground: 'rgba(99, 102, 241, 0.4)',
                chipColor: '#eef2ff',
                textColor: '#eef2ff',
                benefits: [
                    '2x puntos por cada S/ 1',
                    'Manager personal de compras',
                    'Eventos privados y primeras unidades',
                    'Env√≠o express gratis'
                ]
            }
        ];

        const currencyFormatter = new Intl.NumberFormat('es-PE', {
            style: 'currency',
            currency: 'PEN',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });

        const loyaltyState = {
            points: 0,
            tier: LOYALTY_TIERS[0]
        };

        function setupLoyaltyButtons() {
            const redeemBtn = document.getElementById('loyaltyRedeemButton');
            if (redeemBtn && !redeemBtn.dataset.listenerAttached) {
                redeemBtn.addEventListener('click', handleLoyaltyRedeem);
                redeemBtn.dataset.listenerAttached = 'true';
            }

            const learnMoreBtn = document.getElementById('loyaltyLearnMoreButton');
            if (learnMoreBtn && !learnMoreBtn.dataset.listenerAttached) {
                learnMoreBtn.addEventListener('click', handleLoyaltyLearnMore);
                learnMoreBtn.dataset.listenerAttached = 'true';
            }
        }

        function handleLoyaltyRedeem() {
            const equivalent = loyaltyState.points / LOYALTY_POINTS_TO_CURRENCY_RATE;
            if (loyaltyState.points < 100) {
                window.notifications?.info?.(`Necesitas al menos 100 puntos para canjear. Actualmente tienes ${loyaltyState.points.toLocaleString('es-PE')} puntos disponibles.`);
                return;
            }

            window.notifications?.success?.(`Podr√°s canjear hasta ${currencyFormatter.format(equivalent)} de descuento usando tus ${loyaltyState.points.toLocaleString('es-PE')} puntos en el proceso de checkout.`);
        }

        function handleLoyaltyLearnMore() {
            window.notifications?.info?.('Muy pronto activaremos una secci√≥n con todos los beneficios y reglas del programa. Por ahora, revisa este resumen en tu perfil.');
        }

        function getLoyaltyTier(points) {
            let currentTier = LOYALTY_TIERS[0];
            for (const tier of LOYALTY_TIERS) {
                if (points >= tier.min) {
                    currentTier = tier;
                }
            }
            return currentTier;
        }

        function getNextTier(currentTier) {
            const index = LOYALTY_TIERS.findIndex(tier => tier.id === currentTier.id);
            if (index === -1 || index === LOYALTY_TIERS.length - 1) {
                return null;
            }
            return LOYALTY_TIERS[index + 1];
        }

        function updateLoyaltyUI(points) {
            loyaltyState.points = Math.max(0, Number(points || 0));
            const tier = getLoyaltyTier(loyaltyState.points);
            const nextTier = getNextTier(tier);
            loyaltyState.tier = tier;
            loyaltyState.nextTier = nextTier;

            const loyaltyCard = document.querySelector('.loyalty-points-card');
            if (loyaltyCard) {
                loyaltyCard.style.setProperty('--loyalty-gradient', tier.gradient);
                loyaltyCard.style.setProperty('--loyalty-text-color', tier.textColor || '#ffffff');
            }

            const tierChip = document.getElementById('loyaltyTierChip');
            if (tierChip) {
                tierChip.style.background = tier.chipBackground;
                tierChip.style.color = tier.chipColor;
                const icon = tierChip.querySelector('i');
                if (icon) {
                    icon.className = tier.icon;
                }
                const tierName = document.getElementById('loyaltyTierName');
                if (tierName) {
                    tierName.textContent = `Nivel ${tier.name}`;
                }
            }

            const pointsValueEl = document.getElementById('loyaltyPointsValue');
            if (pointsValueEl) {
                animateCounter(pointsValueEl, loyaltyState.points, {
                    formatter: value => Math.round(value).toLocaleString('es-PE')
                });
            }

            const equivalentEl = document.getElementById('loyaltyPointsEquivalent');
            if (equivalentEl) {
                equivalentEl.textContent = currencyFormatter.format(loyaltyState.points / LOYALTY_POINTS_TO_CURRENCY_RATE);
            }

            const multiplierEl = document.getElementById('loyaltyPointsMultiplier');
            if (multiplierEl) {
                const multiplierText = tier.multiplier % 1 === 0 ? `${tier.multiplier}x` : `${tier.multiplier.toFixed(2)}x`;
                multiplierEl.textContent = multiplierText;
            }

            const benefitsList = document.getElementById('loyaltyBenefitsList');
            if (benefitsList) {
                benefitsList.innerHTML = tier.benefits.map(benefit => `
                    <li><i class="fas fa-check-circle"></i> ${benefit}</li>
                `).join('');
            }

            const progressFill = document.getElementById('loyaltyProgressFill');
            const progressPercentEl = document.getElementById('loyaltyProgressPercent');
            const progressLabelEl = document.getElementById('loyaltyProgressLabel');
            const nextTierMessageEl = document.getElementById('loyaltyNextTierMessage');

            let progress = 1;
            let progressLabel = `¬°Eres ${tier.name}! Disfruta de todos los beneficios.`;

            if (nextTier) {
                const range = nextTier.min - tier.min;
                progress = range > 0 ? (loyaltyState.points - tier.min) / range : 0;
                progress = Math.max(0, Math.min(progress, 1));
                const remaining = Math.max(nextTier.min - loyaltyState.points, 0);
                progressLabel = remaining === 0
                    ? `¬°Listo para subir a ${nextTier.name}!`
                    : `Te faltan ${remaining} puntos para alcanzar el nivel ${nextTier.name}`;

                if (nextTierMessageEl) {
                    nextTierMessageEl.textContent = remaining === 0
                        ? `Una compra m√°s te permitir√° desbloquear el nivel ${nextTier.name}.`
                        : `Suma ${remaining} puntos adicionales para desbloquear el nivel ${nextTier.name}.`;
                }
            } else if (nextTierMessageEl) {
                nextTierMessageEl.textContent = 'Has alcanzado el nivel m√°ximo. Mant√©n tus compras para conservarlo.';
            }

            if (progressFill) {
                progressFill.style.width = `${(progress * 100).toFixed(0)}%`;
            }
            if (progressPercentEl) {
                progressPercentEl.textContent = `${Math.round(progress * 100)}%`;
            }
            if (progressLabelEl) {
                progressLabelEl.textContent = progressLabel;
            }
        }

        function animateCounter(element, endValue, options = {}) {
            const { duration = 800, formatter = value => Math.round(value).toLocaleString('es-PE') } = options;
            const startValue = Number(element?.dataset?.currentValue || 0);
            const targetValue = Number(endValue || 0);
            const startTime = performance.now();

            function step(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easedProgress = 1 - Math.pow(1 - progress, 3);
                const currentValue = startValue + (targetValue - startValue) * easedProgress;
                element.textContent = formatter(currentValue);

                if (progress < 1) {
                    requestAnimationFrame(step);
                } else {
                    element.textContent = formatter(targetValue);
                    element.dataset.currentValue = targetValue;
                }
            }

            requestAnimationFrame(step);
        }

        // Esperar a que todo se cargue
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîµ [PROFILE] DOMContentLoaded ejecutado');
            
            // Inicializar header y footer
            const headerContainer = document.getElementById('mainHeader');
            const footerContainer = document.getElementById('mainFooter');
            
            console.log('üîµ [PROFILE] headerContainer:', headerContainer);
            console.log('üîµ [PROFILE] window.Components:', window.Components);
            
            if (headerContainer && window.Components) {
                console.log('üîµ [PROFILE] Renderizando header...');
                headerContainer.innerHTML = window.Components.getHeader(true, true);
                console.log('üîµ [PROFILE] Header renderizado, llamando initHeader()...');
                window.Components.initHeader();
                window.Components.initSearch();
                window.Components.initCartCounter();
                console.log('üîµ [PROFILE] initHeader() ejecutado');
            }
            
            if (footerContainer && window.Components) {
                footerContainer.innerHTML = window.Components.getFooter();
            }

            // Verificar autenticaci√≥n con retry
            let retries = 0;
            const maxRetries = 5;
            
            const checkAuth = setInterval(() => {
                retries++;
                if (window.authManager && window.authManager.isAuthenticated()) {
                    clearInterval(checkAuth);
                    console.log('‚úÖ Usuario autenticado, cargando perfil');
                    initializeProfile();
                } else if (retries >= maxRetries) {
                    clearInterval(checkAuth);
                    console.log('‚ùå Usuario no autenticado, redirigiendo');
                    window.location.href = 'index.html';
                }
            }, 200);

            setupLoyaltyButtons();
            updateLoyaltyUI(0);

            // Inicializar tabs
            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    switchTab(tabId);
                });
            });
        });

        // Cambiar de tab
        function switchTab(tabId) {
            // Actualizar tabs
            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

            // Actualizar secciones
            document.querySelectorAll('.profile-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            // Cargar datos espec√≠ficos de la secci√≥n
            if (tabId === 'addresses') {
                loadAddresses();
            } else if (tabId === 'points') {
                loadLoyaltyTransactions();
            }
        }

        // Inicializar perfil
        async function initializeProfile() {
            await Promise.all([
                loadUserData(),
                loadStats(),
                loadAddresses(),
                loadLoyaltyPoints()
            ]);
        }

        // Cargar datos del usuario
        async function loadUserData() {
            try {
                const response = await window.api.getProfile();
                
                if (response.success && response.data.user) {
                    const user = response.data.user;
                    
                    // Actualizar header
                    document.getElementById('profileName').textContent = 
                        `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.email || 'Usuario';
                    document.getElementById('profileEmail').textContent = user.email || '';
                    
                    // Actualizar avatar
                    const avatar = document.getElementById('profileAvatar');
                    const initials = `${(user.first_name || 'U')[0]}${(user.last_name || '')[0]}`.toUpperCase() || 'U';
                    avatar.textContent = initials;
                    
                    // Llenar formulario
                    document.getElementById('firstName').value = user.first_name || '';
                    document.getElementById('lastName').value = user.last_name || '';
                    document.getElementById('email').value = user.email || '';
                    document.getElementById('phone').value = user.phone || '';
                } else {
                    window.notifications.error('Error al cargar datos del perfil');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                window.notifications.error('Error al cargar datos del perfil');
            }
        }

        // Cargar estad√≠sticas
        async function loadStats() {
            try {
                // Cargar pedidos
                const ordersResponse = await window.api.getOrders();
                if (ordersResponse.success) {
                    const orders = ordersResponse.data.orders || [];
                    const totalOrdersEl = document.getElementById('totalOrders');
                    if (totalOrdersEl) {
                        animateCounter(totalOrdersEl, orders.length);
                    }
                    
                    const totalSpent = orders.reduce((sum, order) => sum + parseFloat(order.total || 0), 0);
                    const totalSpentEl = document.getElementById('totalSpent');
                    if (totalSpentEl) {
                        animateCounter(totalSpentEl, totalSpent, {
                            formatter: value => currencyFormatter.format(value)
                        });
                    }
                }

                // Cargar wishlist
                const wishlistResponse = await window.api.getWishlist();
                if (wishlistResponse.success) {
                    const lists = wishlistResponse.data.lists || [];
                    const wishlistTotal = lists.reduce((sum, list) => sum + (list.items?.length || 0), 0);
                    const wishlistCountEl = document.getElementById('wishlistCount');
                    if (wishlistCountEl) {
                        animateCounter(wishlistCountEl, wishlistTotal);
                    }
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Cargar direcciones
        async function loadAddresses() {
            const container = document.getElementById('addressesList');
            if (!container) return;

            window.loadingState.renderLoading(container, 'Cargando direcciones...');

            try {
                const response = await window.api.getAddresses();
                
                if (response.success && response.data.addresses) {
                    const addresses = response.data.addresses;
                    
                    if (addresses.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-map-marker-alt"></i>
                                <h3>No tienes direcciones guardadas</h3>
                                <p>Agrega una direcci√≥n para facilitar tus compras</p>
                                <button class="btn btn-primary" onclick="openAddressModal()">
                                    <i class="fas fa-plus"></i> Agregar Direcci√≥n
                                </button>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = addresses.map(addr => `
                        <div class="address-item ${addr.is_default ? 'default' : ''}">
                            <div class="address-item-header">
                                <div class="address-item-title">
                                    <i class="fas fa-${addr.type === 'home' ? 'home' : addr.type === 'work' ? 'briefcase' : 'map-marker-alt'}"></i>
                                    <span>${addr.type === 'home' ? 'Casa' : addr.type === 'work' ? 'Trabajo' : 'Otra'}</span>
                                    ${addr.is_default ? '<span class="default-badge"><i class="fas fa-check"></i> Predeterminada</span>' : ''}
                                </div>
                                <div class="address-item-actions">
                                    <button class="btn btn-sm btn-ghost" onclick="editAddress('${addr.id}')">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <button class="btn btn-sm btn-error" onclick="deleteAddress('${addr.id}')">
                                        <i class="fas fa-trash"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                            <div class="address-item-content">
                                ${addr.street}<br>
                                ${addr.city}, ${addr.region}<br>
                                ${addr.postal_code || ''} ${addr.country}
                            </div>
                        </div>
                    `).join('');
                } else {
                    window.loadingState.renderError(container, response.message || 'Error al cargar direcciones', {
                        className: 'loading-state loading-state-error',
                        spinner: false
                    });
                }
            } catch (error) {
                window.loadingState.renderError(container, error.message || 'Error al cargar direcciones', {
                    className: 'loading-state loading-state-error',
                    spinner: false
                });
            }
        }

        // Cargar puntos de lealtad
        async function loadLoyaltyPoints() {
            try {
                const response = await window.api.getLoyaltyPoints();
                if (response.success && response.data.points !== undefined) {
                    updateLoyaltyUI(Number(response.data.points || 0));
                }
            } catch (error) {
                console.error('Error loading loyalty points:', error);
            }
        }

        // Cargar transacciones de lealtad
        async function loadLoyaltyTransactions() {
            const container = document.getElementById('loyaltyTransactions');
            if (!container) return;

            window.loadingState.renderLoading(container, 'Cargando transacciones de puntos...');

            try {
                const response = await window.api.getLoyaltyTransactions();
                
                if (response.success && response.data.transactions) {
                    const transactions = response.data.transactions;
                    
                    if (transactions.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-star"></i>
                                <h3>No hay transacciones de puntos</h3>
                                <p>Comienza a comprar para ganar puntos</p>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = transactions.map(trans => `
                        <div class="loyalty-transaction">
                            <div>
                                <div class="loyalty-transaction-type">${trans.description || 'Transacci√≥n'}</div>
                                <div style="font-size: 0.875rem; color: var(--gray-500); margin-top: 4px;">
                                    ${new Date(trans.created_at).toLocaleDateString('es-PE')}
                                </div>
                            </div>
                            <div class="loyalty-transaction-amount ${trans.points > 0 ? 'positive' : 'negative'}">
                                ${trans.points > 0 ? '+' : ''}${trans.points}
                            </div>
                        </div>
                    `).join('');
                } else {
                    window.loadingState.renderError(container, response.message || 'Error al cargar transacciones', {
                        className: 'loading-state loading-state-error',
                        spinner: false
                    });
                }
            } catch (error) {
                window.loadingState.renderError(container, error.message || 'Error al cargar transacciones', {
                    className: 'loading-state loading-state-error',
                    spinner: false
                });
            }
        }

        // Guardar datos personales
        document.getElementById('personalDataForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                first_name: document.getElementById('firstName').value,
                last_name: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value
            };

            try {
                const response = await window.api.updateProfile(data);
                
                if (response.success) {
                    window.notifications.success('Perfil actualizado correctamente');
                    await loadUserData();
                } else {
                    window.notifications.error(response.message || 'Error al actualizar perfil');
                }
            } catch (error) {
                window.notifications.error('Error al actualizar perfil');
            }
        });

        // Cambiar contrase√±a
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                window.notifications.error('Las contrase√±as no coinciden');
                return;
            }

            try {
                const response = await window.api.changePassword({
                    current_password: currentPassword,
                    new_password: newPassword
                });

                if (response.success) {
                    window.notifications.success('Contrase√±a cambiada correctamente');
                    document.getElementById('changePasswordForm').reset();
                } else {
                    window.notifications.error(response.message || 'Error al cambiar contrase√±a');
                }
            } catch (error) {
                window.notifications.error('Error al cambiar contrase√±a');
            }
        });

        // Gesti√≥n de direcciones
        function openAddressModal(addressId = null) {
            const modal = document.getElementById('addressModal');
            const form = document.getElementById('addressForm');
            const title = document.getElementById('addressModalTitle');
            
            if (addressId) {
                title.textContent = 'Editar Direcci√≥n';
                // Cargar datos de la direcci√≥n
                // TODO: Implementar carga de datos
            } else {
                title.textContent = 'Nueva Direcci√≥n';
                form.reset();
            }
            
            modal.classList.add('active');
        }

        function closeAddressModal() {
            const modal = document.getElementById('addressModal');
            modal.classList.remove('active');
            document.getElementById('addressForm').reset();
        }

        document.getElementById('addressForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                type: document.getElementById('addressType').value,
                street: document.getElementById('addressStreet').value,
                city: document.getElementById('addressCity').value,
                region: document.getElementById('addressRegion').value,
                postal_code: document.getElementById('addressPostalCode').value,
                country: document.getElementById('addressCountry').value,
                is_default: document.getElementById('addressIsDefault').checked
            };

            const addressId = document.getElementById('addressId').value;
            
            try {
                let response;
                if (addressId) {
                    response = await window.api.updateAddress(addressId, data);
                } else {
                    response = await window.api.createAddress(data);
                }

                if (response.success) {
                    window.notifications.success(addressId ? 'Direcci√≥n actualizada' : 'Direcci√≥n creada');
                    closeAddressModal();
                    await loadAddresses();
                } else {
                    window.notifications.error(response.message || 'Error al guardar direcci√≥n');
                }
            } catch (error) {
                window.notifications.error('Error al guardar direcci√≥n');
            }
        });

        function editAddress(addressId) {
            openAddressModal(addressId);
            // TODO: Cargar datos de la direcci√≥n
        }

        async function deleteAddress(addressId) {
            if (!confirm('¬øEst√°s seguro de eliminar esta direcci√≥n?')) return;

            try {
                const response = await window.api.deleteAddress(addressId);
                
                if (response.success) {
                    window.notifications.success('Direcci√≥n eliminada');
                    await loadAddresses();
                } else {
                    window.notifications.error('Error al eliminar direcci√≥n');
                }
            } catch (error) {
                window.notifications.error('Error al eliminar direcci√≥n');
            }
        }

        function cancelEdit(section) {
            // Recargar datos para descartar cambios
            if (section === 'personal') {
                loadUserData();
            }
        }

        // Cerrar modal al hacer click fuera
        document.getElementById('addressModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddressModal();
            }
        });

        // Logout Button
        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
            logoutButton.addEventListener('click', async function() {
                if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                    try {
                        console.log('üî¥ [PROFILE] Cerrando sesi√≥n...');
                        
                        // Llamar a logout de authManager
                        if (window.authManager) {
                            await window.authManager.logout();
                        }
                        
                        // Limpiar cualquier dato local adicional
                        localStorage.removeItem('token');
                        sessionStorage.clear();
                        
                        // Mostrar notificaci√≥n
                        if (window.notifications) {
                            window.notifications.success('Sesi√≥n cerrada exitosamente');
                        }
                        
                        // Esperar un momento para que se vea la notificaci√≥n
                        setTimeout(() => {
                            // Redirigir a la p√°gina principal
                            window.location.href = 'index.html';
                        }, 500);
                        
                    } catch (error) {
                        console.error('Error al cerrar sesi√≥n:', error);
                        if (window.notifications) {
                            window.notifications.error('Error al cerrar sesi√≥n');
                        }
                        // Redirigir de todas formas
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 500);
                    }
                }
            });
        }
    </script>
</body>
</html>
